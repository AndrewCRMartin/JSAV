/** @preserve 
    @file
    JSAV V1.3 16.06.14
    Copyright:  (c) Dr. Andrew C.R. Martin, UCL, 2014
    This program is distributed under the Gnu Public Licence (GPLv2)
*/
function printJSAV(divId,sequences,options){if(options==undefined){options=Array()}if(options.width==undefined){options.width="400px"}if(options.height==undefined){options.height="6pt"}if(options.submitLabel==undefined){options.submitLabel="Submit Sequences"}if(options.actionLabel==undefined){options.actionLabel="Process Sequences"}if(options.nocolor){options.nocolour=true}if(options.toggleNocolor){options.toggleNocolour=true}JSAV_init();gOptions[divId]=options;gSequences[divId]=sequences;gSequenceLengths[divId]=sequences[0].sequence.length;document.writeln("<div id='"+divId+"'>");document.writeln("<div id='"+divId+"_sortable' class='JSAVDisplay'>");var html=JSAV_buildSequencesHTML(divId,sequences,options.sortable,options.selectable,options.highlight,options.dotify,options.nocolour);document.write(html);document.writeln("</div>");document.writeln("<div class='JSAVControls'>");if(options.sortable){var start=1;var stop=gSequenceLengths[divId];JSAV_printSlider(divId,stop,options.width,options.height);var html="<button type='button' onclick='JSAV_sortAndRefreshSequences(\""+divId+'", true, '+options.selectable+", "+options.border+")'>Sort</button>";document.writeln(html)}if(options.selectable&&options.deletable){JSAV_printDelete(divId)}if(options.submit!=undefined){JSAV_printSubmit(divId,options.submit,options.submitLabel)}if(options.action!=undefined){JSAV_printAction(divId,options.action,options.actionLabel)}if(options.toggleDotify){document.writeln("<br />");JSAV_printToggleDotify(divId,options);if(options.toggleNocolour){JSAV_printToggleNocolour(divId,options)}}document.writeln("</div>");document.writeln("</div>");if(options.border){JSAV_modifyCSS(divId)}}function JSAV_printToggleDotify(divId,options){var html="";var checked="";if(options.dotify){checked=" checked='checked'"}var id=divId+"_toggleDotify";var idText=" id='"+id+"'";var onclick=" onclick='JSAV_toggleOption(\""+divId+'", "'+id+'", "dotify")\'';html+="<span><input type='checkbox'"+idText+checked+onclick+"/>Dotify</span>";document.writeln(html)}function JSAV_printToggleNocolour(divId,options){var html="";var checked="";if(options.nocolour){checked=" checked='checked'"}var id=divId+"_toggleNocolour";var idText=" id='"+id+"'";var onclick=" onclick='JSAV_toggleOption(\""+divId+'", "'+id+'", "nocolour")\'';html+="<span><input type='checkbox'"+idText+checked+onclick+"/>Do not colour dots</span>";document.writeln(html)}function JSAV_toggleOption(divId,theButton,theOption){var tag="#"+theButton;var options=gOptions[divId];options[theOption]=$(tag).prop("checked");if(options.sorted){JSAV_sortAndRefreshSequences(divId,options.sortable,options.selectable,options.border)}else{JSAV_refresh(divId,gSequences[divId],options.sortable,options.selectable,options.border,gStartPos[divId]-1,gStopPos[divId]-1,options.highlight,options.dotify,options.nocolour)}}function JSAV_buildHighlightHTML(divId,seqLen,selectable,highlight){var html="";if(selectable){html+="<tr class='highlightrow'><th></th>";html+="<td></td>"}else{html+="<tr class='highlightrow'><td></td>"}for(var i=0;i<seqLen;i++){var displayClass="unhighlighted";for(var j=0;j<highlight.length;j+=2){var start=highlight[j];var stop=highlight[j+1];if(i>=start&&i<=stop){displayClass="highlighted";break}}html+="<td class='"+displayClass+"' /></td>"}html+="</tr>\n";return html}function JSAV_printDelete(divId){var html="<button type='button' onclick='JSAV_deleteSelectedSequences(\""+divId+"\")'>Delete Selected</button>";document.writeln(html)}function JSAV_printSubmit(divId,url,label){var html="<button type='button' onclick='JSAV_submitSequences(\""+divId+"\")'>"+label+"</button>";document.writeln(html);var formId=divId+"_form";var html="<div style='display:none'><form id='"+formId+"' action='"+url+"' method='post'>";var textId=divId+"_submit";html+="<textarea id='"+textId+"' name='sequences'></textarea>";html+="</form></div>";document.writeln(html)}function JSAV_printAction(divId,action,label){var html="<button type='button' onclick='JSAV_wrapAction(\""+divId+'", "'+action+"\")'>"+label+"</button>";document.writeln(html)}function JSAV_wrapAction(divId,action){var selectedSequences=Array();var count=0;var toSubmit=Array();var tag="#"+divId+" .selectCell input";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).parent().parent().attr("id");toSubmit[id]=1;count++}});var textTag="textarea#"+divId+"_submit";var sequenceText="";var sequences=gSequences[divId];for(var i=0;i<sequences.length;i++){if(count==0||count==sequences.length||toSubmit[sequences[i].id]==1){selectedSequences.push({id:sequences[i].id,sequence:sequences[i].sequence})}}window[action](divId,selectedSequences)}function JSAV_submitSequences(divId){var count=0;var toSubmit=Array();var tag="#"+divId+" .selectCell input";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).parent().parent().attr("id");toSubmit[id]=1;count++}});var textTag="textarea#"+divId+"_submit";var sequenceText="";var sequences=gSequences[divId];for(var i=0;i<sequences.length;i++){if(count==0||count==sequences.length||toSubmit[sequences[i].id]==1){sequenceText+=">"+sequences[i].id+"\n";sequenceText+=sequences[i].sequence+"\n"}}$(textTag).text(sequenceText);var formTag="#"+divId+"_form";$(formTag).submit()}function JSAV_deleteSelectedSequences(divId){var count=0;var toDelete=Array();var tag="#"+divId+" .selectCell input";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).parent().parent().attr("id");toDelete.push(id);count++}});if(count==0){ACRM_alert("Error!","You must select some sequences!")}else if(count==gSequences[divId].length){ACRM_alert("Error!","You can't delete all the sequences!")}else{var message="Delete "+count+" selected sequences?";ACRM_confirm("Confirm",message,function(confirm){if(confirm){for(var i=0;i<toDelete.length;i++){ACRM_deleteItemByLabel("id",toDelete[i],gSequences[divId])}var options=gOptions[divId];JSAV_refresh(divId,gSequences[divId],options.sortable,options.selectable,options.border,gStartPos[divId]-1,gStopPos[divId]-1,options.highlight,options.dotify,options.nocolour);options.sorted=false}})}}function JSAV_selectAllOrNone(divId){var tag="#"+divId+"_AllNone";if($(tag).prop("checked")){JSAV_selectAll(divId)}else{JSAV_unselectAll(divId)}}function JSAV_selectAll(divId){var tag="#"+divId+" .selectCell input";$(tag).prop("checked",true)}function JSAV_unselectAll(divId){var tag="#"+divId+" .selectCell input";$(tag).prop("checked",false)}function JSAV_modifyCSS(divId){var selector="#"+divId+" .JSAV td";$(selector).css("border","1px solid white")}function JSAV_buildASequenceHTML(id,sequence,prevSequence,selectable,dotify,nocolour){var seqArray=sequence.split("");var prevSeqArray=undefined;if(dotify&&prevSequence!=undefined){prevSeqArray=prevSequence.split("")}var tableLine="<tr id='"+id+"'>";tableLine+="<th class='titleCell'>"+id+"</th>";if(selectable){var name="select_"+id;tableLine+="<th class='selectCell'><input type='checkbox' name='"+name+"' /></th>"}var nResidues=seqArray.length;if(dotify){for(var i=0;i<nResidues;i++){var aa=seqArray[i];var prevAa="#";var colourClass="aa"+aa;if(nocolour){if(aa=="-"){colourClass="aaDel"}}if(prevSeqArray!=undefined){prevAa=prevSeqArray[i]}if(aa==prevAa){if(nocolour){if(aa=="-"){colourClass="aaDel"}else{colourClass="aaDot"}}if(aa!="-"){aa="."}}tableLine+="<td class='"+colourClass+"'>"+aa+"</td>"}}else{for(var i=0;i<nResidues;i++){var aa=seqArray[i];tableLine+="<td class='aa"+aa+"'>"+aa+"</td>"}}tableLine+="</td></tr>";return tableLine}function JSAV_printSlider(divId,seqLen,width,height){document.writeln("<span id='"+divId+"_showrange'></span>");document.writeln("<span id='"+divId+"_slider' style='font-size: "+height+";'></span>");var id=divId+"_slider";var tag="#"+id;$(tag).css("width",width);$(tag).css("margin","10px");$(tag).css("display","block");$(tag).slider({range:true,min:1,max:seqLen,values:[1,seqLen],slide:JSAV_showRange});JSAV_showRange(divId)}function JSAV_showRange(eventOrId,ui){if(ui==null){var tag="#"+eventOrId+"_slider";gStartPos[eventOrId]=$(tag).slider("values",0);gStopPos[eventOrId]=$(tag).slider("values",1);tag="#"+eventOrId+"_showrange";var html="Sort from: "+gStartPos[eventOrId]+" to: "+gStopPos[eventOrId];$(tag).text(html);JSAV_markRange(eventOrId,gSequenceLengths[eventOrId],gStartPos[eventOrId]-1,gStopPos[eventOrId]-1)}else{var id=$(this).parent().parent().attr("id");var tag="#"+id+"_showrange";gStartPos[id]=ui.values[0];gStopPos[id]=ui.values[1];var html="Sort from: "+gStartPos[id]+" to: "+gStopPos[id];$(tag).text(html);JSAV_markRange(id,gSequenceLengths[id],gStartPos[id]-1,gStopPos[id]-1)}}function JSAV_getRange(divId){var start=gStartPos[divId]-1;var stop=gStopPos[divId]-1;return[start,stop]}function JSAV_buildSequencesHTML(divId,sequences,sortable,selectable,highlight,dotify,nocolour){var html="";html+="<div class='JSAV'>\n";html+="<table border='0'>\n";if(selectable){html+=JSAV_buildSelectAllHTML(divId,gSequenceLengths[divId])}if(highlight!=undefined){html+=JSAV_buildHighlightHTML(divId,gSequenceLengths[divId],selectable,highlight)}for(var i=0;i<sequences.length;i++){var prevSequence=undefined;if(i>0){prevSequence=sequences[i-1].sequence}html+=JSAV_buildASequenceHTML(sequences[i].id,sequences[i].sequence,prevSequence,selectable,dotify,nocolour)+"\n"}if(highlight!=undefined){html+=JSAV_buildHighlightHTML(divId,gSequenceLengths[divId],selectable,highlight)}if(sortable){html+=JSAV_buildMarkerHTML(divId,gSequenceLengths[divId],selectable)}html+="</table>\n";html+="</div>\n";return html}function JSAV_buildSelectAllHTML(divId,seqLen){var html;var id=divId+"_AllNone";html="<tr><th>All/None</th><th><input id='"+id+"' type='checkbox' onclick='JSAV_selectAllOrNone(\""+divId+"\");' /></th>";for(var i=0;i<seqLen;i++){html+="<td></td>"}html+="</tr>";return html}function JSAV_buildMarkerHTML(divId,seqLen,selectable){var html="";if(selectable){html+="<tr class='markerrow'><th>Sort Region:</th>";html+="<th class='selectCell'></th>"}else{html+="<tr class='markerrow'><td class='titleCell'>Sort Region:</td>"}for(var i=0;i<seqLen;i++){var id=divId+"_JSAVMarker"+i;html+="<td id='"+id+"' class='unmarked' />&nbsp;</td>"}html+="</tr>\n";return html}function JSAV_FindRealSequenceEnds(seqArray){var seqEnds=[];seqEnds[0]=0;while(seqArray[seqEnds[0]]=="-"||seqArray[seqEnds[0]]==" "){seqEnds[0]++}seqEnds[1]=seqArray.length-1;while(seqArray[seqEnds[1]]=="-"||seqArray[seqEnds[1]]==" "){seqEnds[1]--}return seqEnds}function JSAV_chooseRepresentative(differenceMatrix){var totalDiffs=[];var nSeqs=differenceMatrix.length;for(var i=0;i<nSeqs;i++){totalDiffs[i]=0;for(var j=0;j<differenceMatrix[i].length;j++){totalDiffs[i]+=differenceMatrix[i][j]}}var lowestDiff=1e6;var representative=-1;for(var i=0;i<nSeqs;i++){if(totalDiffs[i]<lowestDiff){lowestDiff=totalDiffs[i];representative=i}}return representative}function JSAV_findClosestSequences(sequenceIndexes,refSeq,differenceMatrix){var closestSequences=[];var smallestDifference=1e6;for(var i=0;i<sequenceIndexes.length;i++){var thisDifference=differenceMatrix[sequenceIndexes[i]][refSeq];if(thisDifference<smallestDifference){smallestDifference=thisDifference;closestSequences=[];closestSequences.push(sequenceIndexes[i])}else if(thisDifference==smallestDifference){closestSequences.push(sequenceIndexes[i])}}return closestSequences}function JSAV_sortSequences(sequences,start,stop){var sortedSequences=[];var sortedIndexes=[];var nSeqs=sequences.length;var ignoreEnds=false;if(start<0||stop<0||start==0&&stop==sequences[0].sequence.length-1){ignoreEnds=true}var used=[];for(var i=0;i<nSeqs;i++){used[i]=0}var differenceMatrix=JSAV_calcDifferenceMatrix(sequences,start,stop,ignoreEnds);var representative=JSAV_chooseRepresentative(differenceMatrix);sortedIndexes[0]=representative;used[representative]=1;var nSortedSeqs=1;while(nSortedSeqs<nSeqs){var unusedSequences=[];for(var i=0;i<nSeqs;i++){if(!used[i]){unusedSequences.push(i)}}var closestSequencesToLast=JSAV_findClosestSequences(unusedSequences,sortedIndexes[nSortedSeqs-1],differenceMatrix);var closestSequencesToReference=JSAV_findClosestSequences(closestSequencesToLast,sortedIndexes[0],differenceMatrix);var mostSimilar=closestSequencesToReference[0];sortedIndexes[nSortedSeqs++]=mostSimilar;used[mostSimilar]=1}for(var i=0;i<nSeqs;i++){sortedSequences[i]=sequences[sortedIndexes[i]]}return sortedSequences}function JSAV_calcDifferenceMatrix(sequences,start,stop,ignoreEnds){var nSeq=sequences.length;var differenceMatrix=ACRM_createArray(nSeq,nSeq);for(var i=0;i<nSeq;i++){for(var j=0;j<nSeq;j++){differenceMatrix[i][j]=JSAV_calcDifference(sequences[i].sequence,sequences[j].sequence,start,stop,ignoreEnds)}}return differenceMatrix}function JSAV_calcDifference(seq1,seq2,regionStart,regionStop,ignoreEnds){var seqArray1=[];seq1.substring(regionStart,regionStop+1).split("");var seqArray2=[];if(regionStart<0||regionStop<0){seqArray1=seq1.split("");seqArray2=seq2.split("")}else{seqArray1=seq1.substring(regionStart,regionStop+1).split("");seqArray2=seq2.substring(regionStart,regionStop+1).split("")}var differences=0;var seqLen=Math.max(seqArray1.length,seqArray2.length);var start=0;var stop=seqLen-1;if(ignoreEnds){var seq1Ends=JSAV_FindRealSequenceEnds(seqArray1);var seq2Ends=JSAV_FindRealSequenceEnds(seqArray2);start=Math.max(seq1Ends[0],seq2Ends[0]);stop=Math.min(seq1Ends[1],seq2Ends[1])}for(var i=start;i<=stop;i++){if(seqArray1[i]!=seqArray2[i]){differences++}}return differences}function JSAV_sortAndRefreshSequences(divId,sortable,selectable,border){var id=divId+"_JSAVStart";var range=JSAV_getRange(divId);var sortedSequences=JSAV_sortSequences(gSequences[divId],range[0],range[1]);JSAV_refresh(divId,sortedSequences,sortable,selectable,border,range[0],range[1],gOptions[divId].highlight,gOptions[divId].dotify,gOptions[divId].nocolour);gOptions[divId].sorted=true;return false}function JSAV_refresh(divId,sequences,sortable,selectable,border,start,stop,highlight,dotify,nocolour){var html=JSAV_buildSequencesHTML(divId,sequences,sortable,selectable,highlight,dotify,nocolour);var element=document.getElementById(divId+"_sortable");element.innerHTML=html;if(border){JSAV_modifyCSS(divId)}JSAV_markRange(divId,gSequenceLengths[divId],start,stop)}function JSAV_markRange(divId,seqLen,start,stop){for(var i=0;i<seqLen;i++){var id=divId+"_JSAVMarker"+i;document.getElementById(id).className="unmarked"}if(start>=0&&stop>=0){for(var i=start;i<=stop;i++){var id=divId+"_JSAVMarker"+i;document.getElementById(id).className="marked"}}}function JSAV_init(){try{if(gSequences==undefined){}}catch(err){gSequences=Array();gOptions=Array();gSequenceLengths=Array();gStartPos=Array();gStopPos=Array()}}function ACRM_deleteItemByLabel(key,value,array){for(var i=0;i<array.length;i++){if(array[i][key]==value){array.splice(i,1);break}}}function ACRM_createArray(length){var arr=new Array(length||0),i=length;if(arguments.length>1){var args=Array.prototype.slice.call(arguments,1);while(i--)arr[length-1-i]=ACRM_createArray.apply(this,args)}return arr}function ACRM_confirm(title,msg,callback){var dialogObj=$("<div style='display:none' title='"+title+"'>"+msg+"</div>");$("body").append(dialogObj);$(dialogObj).dialog({resizable:false,modal:true,buttons:{Cancel:function(){callback(false);$(this).dialog("close");$(this).remove()},OK:function(){callback(true);$(this).dialog("close");$(this).remove()}}})}function ACRM_alert(title,msg){var dialogObj=$("<div style='display:none' title='"+title+"'>"+msg+"</div>");$("body").append(dialogObj);$(dialogObj).dialog({resizable:false,modal:true,buttons:{OK:function(){$(this).dialog("close");$(this).remove()}}})}