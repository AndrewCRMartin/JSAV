/** @preserve 
    @file
    JSAV V2.0 13.05.19
    Copyright:  (c) Dr. Andrew C.R. Martin, UCL, 2014-2016
    This program is distributed under the Gnu Public Licence (GPLv2)
*/
function printJSAV(divId,sequences,options){if(options==undefined){options=Array()}if(options.width==undefined){options.width="400px"}if(options.height==undefined){options.height="6pt"}if(options.nocolor){options.nocolour=true}if(options.toggleNocolor){options.toggleNocolour=true}if(options.transpose==undefined){options.transpose=false}if(options.colorScheme){options.colourScheme=options.colorScheme}if(options.colourScheme==undefined){options.colourScheme="taylor"}if(options.selectColor){options.selectColour=true}if(options.colourChoices==undefined){options.colourChoices=JSAV_initColourChoices()}if(options.colorChoices!=undefined){options.colourChoices=options.colorChoices}if(options.deletable){options.selectable=true}if(options.hideable){options.selectable=true}if(options.exportable){options.selectable=true}if(options.submit!=undefined){options.selectable=true}if(options.idSubmitAttribute==undefined){options.idSubmitAttribute="sequence"}if(options.idSubmitKey==undefined){options.idSubmitKey=""}if(options.autoLabels){options.labels=JSAV_autoLabels(sequences)}if(options.chainType==undefined){options.chainType="heavy"}if(options.iconButtons){if(options.submitLabel==undefined){options.submitLabel="far fa-check-square"}if(options.actionLabel==undefined){options.actionLabel="fa fa-cogs"}if(options.exportLabel==undefined){options.exportLabel="fas fa-share-square"}if(options.sortLabel==undefined){options.sortLabel="fa fa-sort-down"}if(options.sortUpLabel==undefined){options.sortUpLabel="fas fa-sort-up"}if(options.sortDownLabel==undefined){options.sortDownLabel="fas fa-sort-down"}if(options.sortBothLabel==undefined){options.sortBothLabel="fas fa-sort"}if(options.toggleDotifyLabel==undefined){options.toggleDotifyLabel="fa fa-ellipsis-h"}if(options.toggleNocolourLabel==undefined){options.toggleNocolourLabel="fa fa-th"}if(options.hideLabel==undefined){options.hideLabel="fa fa-eye-slash"}if(options.showallLabel==undefined){options.showallLabel="fa fa-eye"}if(options.deleteLabel==undefined){options.deleteLabel="fa fa-window-close"}options.sortUpText="";options.sortDownText="";options.sortBothText="";options.hideText=""}else{options.sortUpText="&#9650;";options.sortDownText="&#9660;";options.sortBothText="&#9670;";options.hideText="&#9747"}JSAV_init();mouseUpHandler();document.onmouseup=mouseUpHandler;gOptions[divId]=options;tidySequences(divId,sequences);gSequences[divId]=sequences;initDisplayrow(gSequences[divId]);gDisplayColumn[options.chainType]=initDisplayColumn(divId,sequences,gDisplayColumn[options.chainType]);gDisplayOrder[divId]=initDisplayOrder(sequences);gSorted[divId]=false;if(sequences.length>0){gSequenceLengths[divId]=sequences[0].sequence.length;if(gSequenceLengths[divId]>0){if(options.consensus){gConsensus[divId]=JSAV_buildConsensus(sequences)}var div="";if($("#"+divId).length==0){div=$("<div />").appendTo($("body"));div.attr("id",divId)}else{div=$("#"+divId)}var div_sortable=$("<div />").appendTo(div);div_sortable.attr("id",divId+"_sortable");div_sortable.css("margin-left","0.5em");div_sortable.css("overflow-x","auto");div_sortable.css("white-space","nowrap");if(options.scrollY!=null){div_sortable.css("overflow-y","hidden");div_sortable.css("white-space","nowrap")}if(options.transpose){var html=JSAV_transposeSequencesHTML(divId,sequences)}else{var html=JSAV_buildSequencesHTML(divId,sequences)}div_sortable.append(html);$("#"+divId+" .seqtable").css("width",seqtabWidth);$("#"+divId+" .outerseqtable").css("width",seqtabWidth);$("#"+divId+" .header").css("width",seqtabWidth);$("#"+divId+" .footer").css("width",seqtabWidth);var div_controls=$("<div />").appendTo(div);div_controls.attr("id",divId+"_controls");div_controls.attr("class","JSAVControls");div_controls.css("margin-left","0.5em");if(options.sortable){resetSortRegion(divId);JSAV_ControlButton(divId,divId+"_controls","Sort the sequences based on the range specified in the Sort Region",options.sortLabel,"","Sort Sequences",'JSAV_sortAndRefreshSequences("'+divId+'")')}if(options.hideable){JSAV_ControlButton(divId,divId+"_controls","Hide selected sequences",options.hideLabel,"","Hide Sequences",'JSAV_hideSelectedSequences("'+divId+'")');JSAV_ControlButton(divId,divId+"_controls","Show hidden sequences",options.showallLabel,"","Show Hidden Sequences",'JSAV_resetDisplayrow("'+divId+'")')}if(options.deletable){JSAV_ControlButton(divId,divId+"_controls","Delete the selected sequences",options.deleteLabel,"","Delete Sequences",'JSAV_deleteSelectedSequences("'+divId+'")')}if(options.submit!=undefined){JSAV_printSubmit(divId,options.submit,options.submitLabel)}if(options.action!=undefined){JSAV_ActionButton(divId,divId+"_controls","Process the selected sequences, or all sequences if none selected",options.actionLabel,"","Process Sequences",options.action)}if(options.selectColour){JSAV_printColourSelector(divId,options)}if(options.toggleDotify){JSAV_printToggleDotify(divId,options)}if(options.toggleNocolour){JSAV_printToggleNocolour(divId,options)}if(options.toggleTranspose){JSAV_printToggleTranspose(divId,options)}if(options.fasta){JSAV_ControlButton(divId,divId+"_controls","Export the selected sequences, or all sequences if none selected",options.exportLabel,"Fasta","Export Fasta",'JSAV_exportFASTA("'+divId+'")')}if(options.exportable){JSAV_ControlButton(divId,divId+"_controls","Export visible sequences to CSV",options.exportLabel,"CSV","Export CSV",'JSON2CSV("'+divId+'")');JSAV_ControlButton(divId,divId+"_controls","Export visible sequences to XML for Excel - your Excel must support XML import",options.exportLabel,"Excel","Export Excel",'JSON2XML("'+divId+'")')}if(options.frequencies){JSAV_printFrequencyControls(divId,divId+"_controls",options)}if(options.border){JSAV_modifyCSS(divId)}}if(options.displaydatatable!=undefined){printDataTable(divId,sequences)}if(options.sortColumn!=undefined){DT_sortColumn(divId,options.sortDirection,options.sortColumn)}window.onload=function(){JSAV_refreshSettings(divId)};if(options.callback!=undefined){window[options.callback](divId)}$("#"+divId).css("width","96vw")}}function initDisplayrow(sequences){for(var s=0;s<sequences.length;s++){sequences[s].displayrow=true}}function JSAV_refreshSettings(divId){if(gOptions[divId].selectColour){var tag="#"+divId+"_selectColour";$(tag).val(gOptions[divId].colourScheme)}if(gOptions[divId].toggleDotify){var tag="#"+divId+"_toggleDotify";if(gOptions[divId].dotify==undefined){$(tag).prop("checked",false)}else{$(tag).prop("checked",gOptions[divId].dotify)}}if(gOptions[divId].toggleNocolour){var tag="#"+divId+"_toggleNocolour";if(gOptions[divId].nocolour==undefined){$(tag).prop("checked",false)}else{$(tag).prop("checked",gOptions[divId].nocolour)}}if(gOptions[divId].selectable){var tag="#"+divId+"_AllNone";$(tag).prop("checked",false)}$("#"+divId+"_seqids").scrollLeft(0)}function JSAV_printColourSelector(divId,options){var id=divId+"_selectColour";var ctype=options.chainType;var html="<div style='float:left'>";html+="<select class='tooltip colourselect "+ctype+"button' title='Select colour scheme' id = '"+id+"' onchange='JSAV_setColourScheme(\""+divId+"\", this)'>";for(var i=0;i<options.colourChoices.length;i++){var lcChoice=options.colourChoices[i].toLowerCase();var selected="";if(options.colourScheme==lcChoice){selected=" selected='selected'"}html+="<option value='"+lcChoice+"'"+selected+">"+options.colourChoices[i]+"</option>"}html+="</select></div>";var parenttag="#"+divId+"_controls";$(parenttag).append(html)}function JSAV_setColourScheme(divId,select){gOptions[divId].colourScheme=select.value;if(gOptions[divId].frequencies){if(select.value=="frequencies"){$("#"+divId+"FrequencyControls").show()}else{$("#"+divId+"FrequencyControls").hide()}}if(gSorted[divId]){JSAV_sortAndRefreshSequences(divId)}else{JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}function JSAV_ControlButton(divId,localDiv,tooltip,icon,label,textlabel,action){var parenttag="#"+localDiv;var options=gOptions[divId];var ctype=options.chainType;var tooltipText="title='"+tooltip+"'";var html="<div style='float:left'><button type='button' class='tooltip "+ctype+"button' "+tooltipText+"  onclick='"+action+"'>";if(options.iconButtons){html+="<i class='"+icon+"' "+tooltipText+"></i> "+label}else{html+=icon!=undefined?icon:textlabel}html+="</button></div>";$(parenttag).append(html)}function JSAV_RunAction(action,divId){var sequences=gSequences[divId];var selectedSequences=Array();var count=0;var toFASTA=Array();var dispOrder=gDisplayOrder[divId];var tag="#"+divId+" .selectBox";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).attr("name").substr(7);toFASTA[id]=1;count++}});for(var i=0;i<sequences.length;i++){if(sequences[dispOrder[i]]==undefined){alert("ERROR!!!! DispOrder["+i+"] undefined")}else{if(sequences[dispOrder[i]].displayrow){if(count==0||count==sequences.length||toFASTA[sequences[dispOrder[i]].id]==1){selectedSequences.push(sequences[dispOrder[i]])}}}}window[action](divId,selectedSequences)}function JSAV_ActionButton(divId,localDiv,tooltip,icon,label,textlabel,action){var parenttag="#"+localDiv;var options=gOptions[divId];var ctype=options.chainType==undefined?"JSAV":options.chainType;var tooltipText="title='"+tooltip+"'";var html="<button type='button' class='tooltip "+ctype+"button' "+tooltipText+" onclick='JSAV_RunAction(\""+action+'", "'+divId+"\")'>";if(options.iconButtons){html+="<i class='"+icon+"' "+tooltipText+"></i> "+label}else{html+=icon!=undefined?icon:textlabel}html+="</button>";$(parenttag).append(html)}function JSAV_exportFASTA(divId){var sequenceText=JSAV_buildFASTA(divId);ACRM_dialog("FASTA Export",sequenceText,600,true)}function JSAV_printToggleDotify(divId,options){var active="";var ctype=options.chainType;if(options.dotify){active=" active"}var id=divId+"_toggleDotify";var label=options.toggleDotifyLabel;var idText=" id='"+id+"'";var onclick=" onclick='JSAV_toggleOption(\""+divId+'", "'+id+'", "dotify")\'';var title="title='Replace repeated residues with dots'";var html="<div style='float:left'><button type='button' class='tooltip "+ctype+"button"+active+"' "+idText+" "+title+" "+onclick+">";if(gOptions[divId].iconButtons){html+="<i class='"+label+"'  "+title+"></i></button>"}else{html+="Dotify</button></div>"}var parenttag="#"+divId+"_controls";$(parenttag).append(html)}function JSAV_printToggleNocolour(divId,options){var active="";var ctype=options.chainType;if(options.nocolour){active=" active"}var id=divId+"_toggleNocolour";var idText=" id='"+id+"'";var label=options.toggleNocolourLabel;var onclick=" onclick='JSAV_toggleOption(\""+divId+'", "'+id+'", "nocolour")\'';var title="title='Do not colour repeated residues'";var html="<div style='float:left'><button type='button' class='tooltip "+ctype+"button"+active+"' "+idText+" "+title+" "+onclick+">";if(gOptions[divId].iconButtons){html+="<i class='"+label+"' "+title+"></i></button>"}else{html+="No Repeat Colour</button></div>"}var parenttag="#"+divId+"_controls";$(parenttag).append(html)}function JSAV_printToggleTranspose(divId,options){var options=gOptions[divId];var ctype=options.chainType;var html="<div style='float:left'>";var activeText="fas fa-reply";var inactiveText="fas fa-share";var active="";if(options.transpose){active=activeText}else{active=inactiveText}var id=divId+"_toggleTranspose";var idText=" id='"+id+"'";var onclick=" onclick='JSAV_toggleTranspose(\""+divId+'", "'+id+'", "transpose", "'+activeText+'",  "'+inactiveText+"\")'";var tooltip="Transpose sequence view";if(options.iconButtons){html+="<button type='button' class='tooltip "+ctype+"button' title='"+tooltip+"' "+onclick+"><i "+idText+" class='"+active+"'></i></button>"}else{html+="<button type='button' class='tooltip "+ctype+"button' "+idText+" title='"+tooltip+"' "+onclick+">Transpose Sequences</button>"}html+="</div>";var parenttag="#"+divId+"_controls";$(parenttag).append(html)}function JSAV_toggleTranspose(divId,theButton,theOption,activeText,inactiveText){var div_sortable=$("#"+divId+"_sortable");var options=gOptions[divId];if(options[theOption]){div_sortable.css("max-height","");$("#"+divId).css("width","96vw")}else{div_sortable.css("max-height","1000px")}JSAV_toggleOptionIcon(divId,theButton,theOption,activeText,inactiveText)}function JSAV_toggleOptionIcon(divId,theButton,theOption,activeText,inactiveText){var tag="#"+theButton;var options=gOptions[divId];options[theOption]=!options[theOption];if(options[theOption]){$(tag).removeClass(inactiveText);$(tag).addClass(activeText)}else{$(tag).removeClass(activeText);$(tag).addClass(inactiveText)}if(gSorted[divId]){JSAV_sortAndRefreshSequences(divId)}else{JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}function JSAV_toggleOption(divId,theButton,theOption){var tag="#"+theButton;var options=gOptions[divId];options[theOption]=!options[theOption];if(options[theOption]){$(tag).addClass("active")}else{$(tag).removeClass("active")}if(gSorted[divId]){JSAV_sortAndRefreshSequences(divId)}else{JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}function JSAV_buildHighlightHTML(divId,seqLen,selectable,highlight,cc){var html="";var pref;for(var i=0;i<seqLen;i++){pref="";if(i==cc){pref="br_highlightrow"}html+=printHighlightCell(highlight,i,pref)}html+="<td class='rhcol'></td>\n";return html}function JSAV_printSubmit(divId,url,label){var parenttag="#"+divId+"_controls";var ctype=gOptions[divId].chainType;var title="title='Submit the selected sequences, or all sequences if none selected'";var html="<button type='button' class='tooltip "+ctype+"button' "+title+" onclick='JSAV_submitSequences(\""+divId+"\")'>";if(gOptions[divId].iconButtons){html+="<i class='"+label+"' "+title+"></i>"}else{html+="Submit Selected Sequences"}html+="</button>";$(parenttag).append(html);var formId=divId+"_form";var html="<div style='display:none'><form id='"+formId+"' action='"+url+"' method='post'>";var textId=divId+"_submit";html+="<textarea id='"+textId+"' name='sequences'></textarea>";html+="</form></div>";$(parenttag).append(html)}function JSAV_wrapAction(divId,action){var selectedSequences=Array();var count=0;var toSubmit=Array();var tag="#"+divId+" .selectBox";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).attr("name").substr(7);toSubmit[id]=1;count++}});var textTag="textarea#"+divId+"_submit";var sequenceText="";var sequences=gSequences[divId];for(var i=0;i<sequences.length;i++){if(count==0||count==sequences.length||toSubmit[sequences[i].id]==1){selectedSequences.push(sequences[i])}}window[action](divId,selectedSequences)}function JSAV_submitSequences(divId){var sequenceText=JSAV_buildFASTA(divId);var textTag="textarea#"+divId+"_submit";$(textTag).text(sequenceText);var formTag="#"+divId+"_form";$(formTag).submit()}function JSAV_buildFASTA(divId){var count=0;var toFASTA=Array();var dispOrder=gDisplayOrder[divId];var tag="#"+divId+" .selectBox";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).attr("name").substr(7);toFASTA[id]=1;count++}});var sequenceText="";var sequences=gSequences[divId];for(var i=0;i<sequences.length;i++){if(sequences[dispOrder[i]].displayrow){if(count==0||count==sequences.length||toFASTA[sequences[dispOrder[i]].id]==1){sequenceText+=">"+sequences[dispOrder[i]].id+"\n";sequenceText+=sequences[dispOrder[i]].sequence+"\n"}}}return sequenceText}function JSAV_deleteSelectedSequences(divId){var count=0;var toDelete=Array();var tag="#"+divId+" .selectBox";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).attr("name").substr(7);toDelete.push(id);count++}});if(count==0){ACRM_alert("Error!","You must select some sequences!")}else if(count==gSequences[divId].length){ACRM_alert("Error!","You can't delete all the sequences!")}else{var message="Delete "+count+" selected sequences?";ACRM_confirm("Confirm",message,function(confirm){if(confirm){for(var i=0;i<toDelete.length;i++){ACRM_deleteItemByLabel("id",toDelete[i],gSequences[divId])}var options=gOptions[divId];if(options.consensus){gConsensus[divId]=JSAV_buildConsensus(gSequences[divId])}if(gSorted[divId]){JSAV_sortAndRefreshSequences(divId)}else{JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}})}}function JSAV_hideSelectedSequences(divId){var count=0;var toHide=Array();var tag="#"+divId+" .selectBox";$(tag).each(function(index){if($(this).prop("checked")){var id=$(this).attr("name").substr(7);toHide.push(id);count++}});if(count==0){ACRM_alert("Error!","You must select some sequences!")}else{for(var i=0;i<toHide.length;i++){JSAV_unsetDisplayrow("id",toHide[i],gSequences[divId])}var options=gOptions[divId];if(options.consensus){gConsensus[divId]=JSAV_buildConsensus(gSequences[divId])}if(gSorted[divId]){JSAV_sortAndRefreshSequences(divId)}else{JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}}function JSAV_unsetDisplayrow(key,value,array){for(var i=0;i<array.length;i++){if(array[i][key]==value){array[i].displayrow=false}}}function JSAV_resetDisplayrow(divId){initDisplayrow(gSequences[divId]);var options=gOptions[divId];if(options.consensus){gConsensus[divId]=JSAV_buildConsensus(gSequences[divId])}if(gSorted[divId]){JSAV_sortAndRefreshSequences(divId)}else{JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}function JSAV_selectAllOrNone(divId,status){var tag="."+divId+"_AllNone";if(status){JSAV_selectAll(divId);$(tag).prop("checked",true)}else{JSAV_unselectAll(divId);$(tag).prop("checked",false)}}function JSAV_resetAllNone(divId,cboxname,cboxstatus){var tag="."+divId+"_AllNone";$(tag).prop("checked",false);tag="."+cboxname;if(cboxstatus){$(tag).prop("checked",true)}else{$(tag).prop("checked",false)}}function JSAV_selectAll(divId){var tag="#"+divId+" .selectBox";$(tag).prop("checked",true);tag="#"+divId+"_Table .selectBox";$(tag).prop("checked",true)}function JSAV_unselectAll(divId){var tag="#"+divId+" .selectBox";$(tag).prop("checked",false);tag="#"+divId+"_Table .selectBox";$(tag).prop("checked",false)}function printFrequencySlider(divId,controlDiv,opts){var lowerlimit="#"+controlDiv.toString()+"lowerlimit";var upperlimit="#"+controlDiv.toString()+"upperlimit";var sliderrange="#"+controlDiv.toString()+"slider";var AboveMax="#"+controlDiv.toString()+"AboveMax";var initialPos=100*(opts.freqMax-opts.freqSlider2)/opts.freqMax;var AboveMaxDiv='<div id="'+controlDiv.toString()+'AboveMax" class="AboveMax" style="width: '+initialPos+'%"></div>';$(sliderrange).slider({range:true,min:0,step:gOptions[divId].freqStep,max:gOptions[divId].freqMax,values:[gOptions[divId].freqSlider1,gOptions[divId].freqSlider2],change:function(event,ui){var disabled=$(sliderrange).slider("option","disabled");if(!disabled){$(lowerlimit).val(ui.values[0]);$(upperlimit).val(ui.values[1]);gOptions[divId].freqSlider1=ui.values[0];gOptions[divId].freqSlider2=ui.values[1];JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1);var max=parseFloat($(sliderrange).slider("option","max"));$(AboveMax).css("width",100*(max-ui.values[0])/max+"%")}},slide:function(event,ui){var disabled=$(sliderrange).slider("option","disabled");if(!disabled){$(lowerlimit).val(ui.values[0]);$(upperlimit).val(ui.values[1]);gOptions[divId].freqSlider1=ui.values[0];gOptions[divId].freqSlider2=ui.values[1];JSAV_refresh(divId,gSequences[divId],gStartPos[divId]-1,gStopPos[divId]-1);var max=parseFloat($(sliderrange).slider("option","max"));$(AboveMax).css("width",100*(max-ui.values[0])/max+"%")}}}).append(AboveMaxDiv);$(sliderrange).slider().addClass("freq-slider");$(lowerlimit).change(function(){var newlowerlim=parseFloat(this.value);$(sliderrange).slider("values",0,newlowerlim);gOptions[divId].freqSlider1=newlowerlim});$(upperlimit).change(function(){var newupperlim=parseFloat(this.value);$(sliderrange).slider("values",1,newupperlim);gOptions[divId].freqSlider2=newupperlim})}function JSAV_printFrequencyControls(divId,controlDiv,opts){var html="";var notshown=gOptions[divId].colourScheme=="frequencies"?"":" notshown";html+="<div class='freqSlider"+notshown+"' id='"+divId+"FrequencyControls'>";html+="<div class='freqSliderLabel'>Frequencies </div>";html+="<div class='freqSliderLimits'>Lower limit: ";html+="<input value='"+opts.freqSlider1+"' name='"+divId+"fsMin' type='number' min='0' max='"+opts.freqMax+"' step='"+opts.freqStep+"' ";html+="id='"+controlDiv+"lowerlimit' class='freqSliderValue' /></div>";html+="<div class='freqSliderLimits'>Upper limit: ";html+="<input value='"+opts.freqSlider2+"' name='"+divId+"fsMax' type='number' min='0' max='"+opts.freqMax+"' step='"+opts.freqStep+"' ";html+="id='"+controlDiv+"upperlimit' class='freqSliderValue' /></div>";html+="<div class='freqSliderLimits' id='"+controlDiv+"slider'></div></div>";$("#"+controlDiv).append(html);printFrequencySlider(divId,controlDiv,opts)}function JSAV_modifyCSS(divId){var selector="#"+divId+" .JSAV td";$(selector).css("border","1px solid white")}function printResidueCell(aa,prevAa,consensusClass,isConsensus,nocolour,dotify,colourScheme,pref,freq,slider1,slider2){var colourClass=colourScheme+aa.toUpperCase();if(colourScheme=="frequencies"&&freq!=undefined&&slider1!=undefined){colourClass="frequencyMed";if(freq<=slider1){colourClass="frequencyMin"}else if(freq>slider2){colourClass="frequencyMax"}}if((dotify||nocolour)&&!isConsensus){if(nocolour){if(aa=="-"){colourClass="aaDel"}}if(aa==prevAa){if(nocolour){if(aa=="-"){colourClass="aaDel"}else{colourClass="aaDot"}}if(dotify){if(aa!="-"){aa="."}}}var html="<td class='"+pref+"seqCell "+colourClass+"'>"+aa+"</td>"}else{var html="<td class='"+pref+"seqCell "+colourClass+consensusClass+"'>"+aa+"</td>"}return html}function JSAV_buildASequenceHTML(divId,id,sequence,frequencies,prevSequence,isConsensus,idSubmit,cc){var options=gOptions[divId];var seqArray=sequence.split("");var prevSeqArray=undefined;if((options.dotify||options.nocolour)&&prevSequence!=undefined){prevSeqArray=prevSequence.split("")}var tableLine="";var consensusClass="";if(isConsensus){if(id=="Consensus"){consensusClass=" consensusCell"}else{consensusClass=" blastqueryCell"}}var pref;var nResidues=seqArray.length;var slider1=options.freqSlider1?options.freqSlider1:undefined;var slider2=options.freqSlider2?options.freqSlider2:undefined;for(var i=0;i<nResidues;i++){pref="";if(i==cc){pref="br_"}var freq=undefined;if(frequencies!=undefined&&options.labels!=undefined){freq=frequencies[options.labels[i]]}var prevAa=prevSeqArray!=undefined?prevSeqArray[i]:"#";tableLine+=printResidueCell(seqArray[i],prevAa,consensusClass,isConsensus,options.nocolour,options.dotify,options.colourScheme,pref,freq,slider1,slider2)}tableLine+="</td><td class='rhcol'></td></tr>";return tableLine}function JSAV_buildTypeLabel(labels){var tableLine="";tableLine+="<tr class='typeLabelRow'></td>";for(var l=0;l<labels.length;l++){var cellCol=labels[l].substring(0,1)=="L"?"light-col":"heavy-col";tableLine+="<td class='"+cellCol+"'></td>"}tableLine+="<td class='rhcol'></td></tr>";return tableLine}function JSAV_showRange(divId){var parenttag="#"+divId+"_controls";var span_showrange=$("<span id='"+divId+"_showrange'></span>").appendTo(parenttag);var tag="#"+divId+"_showrange";if(gOptions[divId].transpose){$(tag).html("")}else{var html="<p>Region: positions "+gStartPos[divId]+" to "+gStopPos[divId]+"</p>";$(tag).html(html);JSAV_markRange(divId,gSequenceLengths[divId],gStartPos[divId]-1,gStopPos[divId]-1)}}function JSAV_getRange(divId){var start=gStartPos[divId]-1;var stop=gStopPos[divId]-1;return[start,stop]}function printHighlightCell(highlight,i,pref){var displayClass="unhighlighted";for(var j=0;j<highlight.length;j+=2){var start=highlight[j];var stop=highlight[j+1];if(i>=start&&i<=stop){displayClass="highlighted";break}}return"<td class='"+displayClass+" "+pref+"' /></td>"}function JSAV_transposeSequencesHTML(divId,sequences){var dispOrder=gDisplayOrder[divId];var options=gOptions[divId];var html="";html+="<div class='JSAV'>\n";var calcwidth=sequences.length*20+250;var tabwidth=calcwidth+"px";$("#"+divId).css("width",tabwidth);html+="<div id='"+divId+"tr_outerseqtable' class='tr_outerseqtable'>";html+="<div class='tr_seqtable'>";html+="<table border='0'>\n";html+="<tr><th class='tr_labels tr_idCell rotate'><div>All/None</div></th>";if(options.selectable)html+="<td class='tr_highlightrow'></td>";for(var i=0;i<sequences.length;i++){if(sequences[dispOrder[i]].displayrow&&numberedSequence(options.chainType,sequences[dispOrder[i]])){var id=sequences[dispOrder[i]].id;if(options.idSubmit==null){html+="<th class='tr_seqCell tr_idCell rotate'><div>"+id+"</div></th>"}else{var idSubmitAttribute=options.idSubmitAttribute;var url=options.idSubmit;var submitParam=sequences[dispOrder[i]][idSubmitAttribute];if(options.idSubmitClean){submitParam=submitParam.replace(/[^A-Za-z0-9]/g,"")}url+=submitParam;html+="<th class='tr_seqCell tr_idCell rotate'><div><a href='"+url+"'>"+id+"</a></div></th>"}}}if(options.consensus!=undefined){html+="<th class='tr_idCell rotate tr_consensusCell'><div>Consensus</div></th>"}if(options.selectable){html+="<td class='tr_highlightrow'></td>"}html+="</tr>";if(options.selectable){html+=JSAV_buildSelectAllHTML(divId,options.selectable,true,"tr_labels");if(options.selectable)html+="<td class='tr_highlightrow'></td>";for(var i=0;i<sequences.length;i++){if(sequences[dispOrder[i]].displayrow&&numberedSequence(options.chainType,sequences[dispOrder[i]])){var name="select_"+sequences[dispOrder[i]].id;var cname=name.replace(/\./g,"_").replace(/\//g,"_");html+="<td class='tr_seqCell tr_selectCell'><input class='selectBox "+cname+" tr_checkbox' type='checkbox' name='"+name;html+="' onclick='JSAV_resetAllNone(\""+divId+'", "'+cname+"\",this.checked);'/></td>"}}if(options.consensus!=undefined){html+="<td class='tr_seqCell tr_consensusCell'></td>"}if(options.selectable){html+="<td class='tr_highlightrow'></td>"}html+="</tr>"}html+="<tr class='topline'><td></td></tr>";for(var i=0;i<gSequenceLengths[divId];i++){var toplineStr=i==0?"topborder":"";html+="<tr><th class='tr_labels idCell "+toplineStr+"'>"+options.labels[i]+"</th>";if(options.selectable){html+=printHighlightCell(options.highlight,i,"tr_highlightrow")}var prevAa="#";var slider1=options.freqSlider1?options.freqSlider1:undefined;var slider2=options.freqSlider2?options.freqSlider2:undefined;for(var s=0;s<sequences.length;s++){if(sequences[dispOrder[s]].displayrow&&numberedSequence(options.chainType,sequences[dispOrder[s]])){var label=options.labels[s];var freq=undefined;if(frequencies!=undefined){freq=sequences[dispOrder[s]].frequencies[options.labels[i]]}var aa=sequences[dispOrder[s]].sequence[i];html+=printResidueCell(aa,prevAa,"",false,options.nocolour,options.dotify,options.colourScheme,"tr_",freq,slider1,slider2);prevAa=sequences[dispOrder[s]].sequence[i]}}if(options.consensus!=undefined){var aa=gConsensus[divId][i];var prevAa="#";html+=printResidueCell(aa,prevAa," tr_consensusCell",true,options.nocolour,options.dotify,options.colourScheme,"tr_",undefined,undefined,undefined)}if(options.selectable){html+=printHighlightCell(options.highlight,i,"tr_highlightrow")}html+="</tr>"}html+="</table>\n";html+="</div>\n";html+="</div>\n";html+="</div>\n";$("#"+divId+"tr_outerseqtable").css("direction","rtl");return html}function JSAV_buildId(divId,attributeValue,id,idSubmit,idSubmitKey,colspan,bgcol,humanOrg){var options=gOptions[divId];var html="";if(idSubmit==null||attributeValue=="undefined"){html+="<td colspan='"+colspan+"' class='"+bgcol+"'><div class='tooltip' title='"+id+"'>"+id+"</div></td>"}else{if(idSubmitKey==""){var url=idSubmit;if(options.idSubmitClean){attributeValue=attributeValue.replace(/[^A-Za-z0-9]/g,"")}url+=attributeValue}else{var url=idSubmit;var seperator="?";var attrArray=attributeValue.split(":");var keyArray=idSubmitKey.split(":");for(var a=0;a<attrArray.length;a++){var submitParam=attrArray[a];var submitKey=keyArray[a];if(options.idSubmitClean){submitParam=submitParam.replace(/[^A-Za-z0-9]/g,"")}url+=seperator+submitKey+"="+submitParam;seperator="&"}}if(humanOrg){url+="&humanorganism="+humanOrg}html+="<td colspan='"+colspan+"' class='"+bgcol+"'><a href='"+url+"'>"+id+"</a></td>"}return html}function numberedSequence(chainType,sequence){if(chainType=="heavy"){return sequence.heavy_Numbered!="N"}else if(chainType=="light"){return sequence.light_Numbered!="N"}else{return sequence.light_Numbered!="N"||sequence.heavy_Numbered!="N"}}function JSAV_buildSequencesHTML(divId,sequences){var options=gOptions[divId];var dispOrder=gDisplayOrder[divId];var html="";html+="<div class='JSAV'>\n";html+="<div class='header'><table border='0'>";html+="<tr><td class='idCell' colspan='10'>Kabat numbering and CDRs</td></tr><tr class='labelrow'>";var cc=chainChange(options.labels,options.autoLabels,divId);if(options.selectable){html+="<td class='idCell'>All/None</td>";html+=JSAV_buildSelectAllHTML(divId,options.selectable,true,"")}else{html+="<td>&nbsp;</td><td class='selectCell'>&nbsp;</td>"}if(options.labels!=undefined){html+=JSAV_buildLabelsHTML(divId,gSequenceLengths[divId],options.labels,cc);html+="<td class='rhcol'></td>"}html+="</tr>";if(options.labeltypecol!=undefined&&options.labels!=undefined){html+="<tr class='typeLabelRow'>";html+="<td></td><td></td>";html+=JSAV_buildTypeLabel(options.labels);html+="</tr>"}if(options.highlight!=undefined){html+="<tr class='highlightrow'>";html+="<th class='idCell'>CDRs</th><td>&nbsp;</td>";html+=JSAV_buildHighlightHTML(divId,gSequenceLengths[divId],options.selectable,options.highlight,cc);html+="</tr>"}if(options.blastaaquery!=undefined&&options.blastaaquery!=""){html+="<tr class='tooltip blastqueryCell seqrow' title='This row shows the blast query sequence.'>";html+="<th class='idCell'>Query</th><th class='selectCell'>&nbsp;</th>";html+=JSAV_buildASequenceHTML(divId,"BlastQuery",options.blastaaquery,undefined,undefined,true,null,cc)+"\n";html+="</tr>"}html+="</table></div>";html+="<div class='outerseqtable'>";html+="<div class='seqtable'>";html+="<table border='0'>\n";var prevSequence=undefined;for(var i=0;i<sequences.length;i++){if(sequences[dispOrder[i]].displayrow!=undefined){if(sequences[dispOrder[i]].displayrow&&numberedSequence(options.chainType,sequences[dispOrder[i]])){html+="<tr class='seqrow' id='"+sequences[dispOrder[i]].id+"'>";var attrArray=options.idSubmitAttribute.split(":");var idSubmitAttr="";for(var a=0;a<attrArray.length;a++)idSubmitAttr+=sequences[dispOrder[i]][attrArray[a]]+":";idSubmitAttr=idSubmitAttr.replace(/:$/,"");html+=JSAV_buildId(divId,idSubmitAttr,sequences[dispOrder[i]].id,options.idSubmit,options.idSubmitKey,1,"idCell",options.humanOrganism)+"\n";var name="select_"+sequences[dispOrder[i]].id;var cname=name.replace(/\./g,"_").replace(/\//g,"_");html+="<th class='selectCell'>";html+=options.selectable?"<input class='"+cname+" selectBox' type='checkbox' name='"+name+"' onclick='JSAV_resetAllNone(\""+divId+'","'+cname+"\",this.checked);'/>":"";html+="</th>";html+=JSAV_buildASequenceHTML(divId,sequences[dispOrder[i]].id,sequences[dispOrder[i]].sequence,sequences[dispOrder[i]].frequencies,prevSequence,false,options.idSubmit,cc)+"\n";prevSequence=sequences[dispOrder[i]].sequence;html+="</tr>"}}}html+="</table>";html+="</div>";html+="</div>";html+="<div class='footer'>";html+="<table border='0'>";if(options.consensus){html+="<tr class='tooltip consensusCell seqrow' title='The consensus shows the most frequent amino acid. This is lower case if &le;50% of the  sequences have that residue.'>";html+="<th class='idCell'>Consensus</th><th class='selectCell'>&nbsp;</th>";html+=JSAV_buildASequenceHTML(divId,"Consensus",gConsensus[divId],undefined,undefined,true,null,cc)+"\n";html+="</tr>"}if(options.highlight!=undefined){html+="<tr class='highlightrow'>";html+="<th class='idCell'>CDRs</th><th class='selectCell'>&nbsp;</th>";html+=JSAV_buildHighlightHTML(divId,gSequenceLengths[divId],options.selectable,options.highlight,cc);html+="</tr>"}if(options.labeltypecol!=undefined&&options.labels!=undefined){html+="<tr class='typeLabelRow'>";html+="<td></td><td></td>";
html+=JSAV_buildTypeLabel(options.labels);html+="</tr>"}if(options.sortable){html+="<tr class='tooltip markerrow' title='Select region for sorting - click here to reset sort region'>";html+="<th class='idCell' onclick='resetSortRegion(\""+divId+"\")';>Sort Region</th><th class='selectCell'>&nbsp;</th>";html+=JSAV_buildMarkerHTML(divId,gSequenceLengths[divId],options.selectable);html+="</tr>"}html+="</table></div>";html+="</div>\n";seqtabWidth=gSequenceLengths[divId]*9+165+"px";return html}function JSAV_buildSelectAllHTML(divId,selectable,displayContent,extraClass){var html="";if(selectable){var id=divId+"_AllNone";var checked=$("."+id).prop("checked")?"checked":"";var content=displayContent?"<input class='tooltop "+id+"' title='Select or deselect all sequences' type='checkbox' "+checked+" onclick='JSAV_selectAllOrNone(\""+divId+"\",this.checked);' />":"";html="<td class='selectCell "+extraClass+"'>"+content+"</td>";gTableWidth[divId]+=20}return html}function JSAV_buildMarkerHTML(divId,seqLen,selectable){var html="";for(var i=0;i<seqLen;i++){var id=divId+"_JSAVMarker"+i;var onmousedown='setSortStart("'+divId+'", '+i+");";var onmouseover='setSortRange("'+divId+'", '+i+");";html+="<td id='"+id+"' onmousedown='"+onmousedown+"' onmouseover='"+onmouseover+"'>&nbsp;</td>"}html+="<td class='rhcol'></td>\n";return html}function setSortStart(divId,i){gStartPos[divId]=i+1;gStopPos[divId]=i+1;mouseState="down";JSAV_showRange(divId)}function setSortRange(divId,i){if(mouseState=="down"){gStopPos[divId]=i+1;JSAV_showRange(divId)}}function resetSortRegion(divId){gStartPos[divId]=1;gStopPos[divId]=gSequenceLengths[divId];JSAV_showRange(divId)}function mouseUpHandler(){mouseState="up"}function JSAV_FindRealSequenceEnds(seqArray){var seqEnds=[];seqEnds[0]=0;while(seqArray[seqEnds[0]]=="-"||seqArray[seqEnds[0]]==" "){seqEnds[0]++}seqEnds[1]=seqArray.length-1;while(seqArray[seqEnds[1]]=="-"||seqArray[seqEnds[1]]==" "){seqEnds[1]--}return seqEnds}function JSAV_chooseRepresentative(differenceMatrix){var totalDiffs=[];var nSeqs=differenceMatrix.length;for(var i=0;i<nSeqs;i++){totalDiffs[i]=0;for(var j=0;j<differenceMatrix[i].length;j++){totalDiffs[i]+=differenceMatrix[i][j]}}var lowestDiff=1e6;var representative=-1;for(var i=0;i<nSeqs;i++){if(totalDiffs[i]<lowestDiff){lowestDiff=totalDiffs[i];representative=i}}return representative}function JSAV_findClosestSequences(sequenceIndexes,refSeq,differenceMatrix){var closestSequences=[];var smallestDifference=1e6;for(var i=0;i<sequenceIndexes.length;i++){var thisDifference=differenceMatrix[sequenceIndexes[i]][refSeq];if(thisDifference<smallestDifference){smallestDifference=thisDifference;closestSequences=[];closestSequences.push(sequenceIndexes[i])}else if(thisDifference==smallestDifference){closestSequences.push(sequenceIndexes[i])}}return closestSequences}function JSAV_sortSequences(sequences,start,stop,divId){var sortedIndexes=[];var nSeqs=sequences.length;var ignoreEnds=false;if(start<0||stop<0||start==0&&stop==sequences[0].sequence.length-1){ignoreEnds=true}var used=[];for(var i=0;i<nSeqs;i++){used[i]=0}var differenceMatrix=JSAV_calcDifferenceMatrix(sequences,start,stop,ignoreEnds);var representative=JSAV_chooseRepresentative(differenceMatrix);sortedIndexes[0]=representative;used[representative]=1;var nSortedSeqs=1;while(nSortedSeqs<nSeqs){var unusedSequences=[];for(var i=0;i<nSeqs;i++){if(!used[i]){unusedSequences.push(i)}}var closestSequencesToLast=JSAV_findClosestSequences(unusedSequences,sortedIndexes[nSortedSeqs-1],differenceMatrix);var closestSequencesToReference=JSAV_findClosestSequences(closestSequencesToLast,sortedIndexes[0],differenceMatrix);var mostSimilar=closestSequencesToReference[0];sortedIndexes[nSortedSeqs++]=mostSimilar;used[mostSimilar]=1}for(var i=0;i<nSeqs;i++){gDisplayOrder[divId][i]=sortedIndexes[i]}}function JSAV_calcDifferenceMatrix(sequences,start,stop,ignoreEnds){var nSeq=sequences.length;var differenceMatrix=ACRM_array(nSeq,nSeq);for(var i=0;i<nSeq;i++){for(var j=0;j<nSeq;j++){differenceMatrix[i][j]=JSAV_calcDifference(sequences[i].sequence,sequences[j].sequence,start,stop,ignoreEnds)}}return differenceMatrix}function JSAV_calcDifference(seq1,seq2,regionStart,regionStop,ignoreEnds){var seqArray1=[];var seqArray2=[];if(regionStart<0||regionStop<0){seqArray1=seq1.split("");seqArray2=seq2.split("")}else{seqArray1=seq1.substring(regionStart,regionStop+1).split("");seqArray2=seq2.substring(regionStart,regionStop+1).split("")}var differences=0;var seqLen=Math.max(seqArray1.length,seqArray2.length);var start=0;var stop=seqLen-1;if(ignoreEnds){var seq1Ends=JSAV_FindRealSequenceEnds(seqArray1);var seq2Ends=JSAV_FindRealSequenceEnds(seqArray2);start=Math.max(seq1Ends[0],seq2Ends[0]);stop=Math.min(seq1Ends[1],seq2Ends[1])}for(var i=start;i<=stop;i++){if(seqArray1[i]!=seqArray2[i]){differences++}}return differences}function JSAV_sortAndRefreshSequences(divId){var id=divId+"_JSAVStart";var range=JSAV_getRange(divId);JSAV_sortSequences(gSequences[divId],range[0],range[1],divId);resetDisplayColumn(gDisplayColumn[gOptions[divId].chaintype],gSequences[divId]);JSAV_refresh(divId,gSequences[divId],range[0],range[1]);gSorted[divId]=true;return false}function JSAV_refresh(divId,sequences,start,stop){var options=gOptions[divId];if(options.transpose){var html=JSAV_transposeSequencesHTML(divId,sequences)}else{var html=JSAV_buildSequencesHTML(divId,sequences)}var element=document.getElementById(divId+"_sortable");element.innerHTML=html;$("#"+divId+" .seqtable").css("width",seqtabWidth);$("#"+divId+" .outerseqtable").css("width",seqtabWidth);$("#"+divId+" .header").css("width",seqtabWidth);$("#"+divId+" .footer").css("width",seqtabWidth);if(options.border){JSAV_modifyCSS(divId)}if(options.sortable){JSAV_showRange(divId)}if(options.displaydatatable!=undefined){printDataTable(divId,sequences)}if(options.callback!=undefined){window[options.callback](divId)}}function JSAV_markRange(divId,seqLen,start,stop){for(var i=0;i<seqLen;i++){var id=divId+"_JSAVMarker"+i;document.getElementById(id).className="unmarked"}if(start>=0&&stop>=0){for(var i=start;i<=stop;i++){var id=divId+"_JSAVMarker"+i;document.getElementById(id).className="marked"}}}function JSAV_init(){try{if(gSequences==undefined){}}catch(err){gSequences=Array();gOptions=Array();gSorted=Array();gTableWidth=Array();gStartPos=Array();gStopPos=Array();gConsensus=Array();gSequenceLengths=Array();gDisplayOrder={};gDisplayColumn={}}}function JSAV_initColourChoices(){return["Taylor","Clustal","Zappo","HPhob"]}function JSAV_buildConsensus(sequences){var nSeqs=sequences.length;var nDispSeqs=0;var seqLen=sequences[0].sequence.length;var aaCounts=Array(seqLen);for(var i=0;i<seqLen;i++){aaCounts[i]=Array()}for(var seq=0;seq<nSeqs;seq++)if(sequences[seq].displayrow){nDispSeqs++;var seqArray=sequences[seq].sequence.split("");for(var pos=0;pos<seqLen;pos++){if(aaCounts[pos][seqArray[pos]]==undefined){aaCounts[pos][seqArray[pos]]=1}else{aaCounts[pos][seqArray[pos]]++}}}var consensus="";var validAAs="ACDEFGHIKLMNPQRSTVWY-".split("");for(var pos=0;pos<seqLen;pos++){var mostCommon=undefined;var maxAA=0;for(var aaCount=0;aaCount<validAAs.length;aaCount++){if(aaCounts[pos][validAAs[aaCount]]!=undefined&&aaCounts[pos][validAAs[aaCount]]>maxAA){mostCommon=validAAs[aaCount];maxAA=aaCounts[pos][validAAs[aaCount]]}}if(maxAA<=nDispSeqs/2){mostCommon=mostCommon.toLowerCase()}consensus+=mostCommon}return consensus}function ACRM_deleteItemByLabel(key,value,array){for(var i=0;i<array.length;i++){if(array[i][key]==value){array.splice(i,1);break}}}function ACRM_array(length){var arr=new Array(length||0),i=length;if(arguments.length>1){var args=Array.prototype.slice.call(arguments,1);while(i--)arr[length-1-i]=ACRM_array.apply(this,args)}return arr}function ACRM_confirm(title,msg,callback){var dialogObj=$("<div style='display:none' title='"+title+"'>"+msg+"</div>");$("body").append(dialogObj);$(dialogObj).dialog({resizable:false,modal:true,buttons:{Cancel:function(){callback(false);$(this).dialog("close");$(this).remove()},OK:function(){$(this).dialog("close");$(this).remove();callback(true)}}})}function ACRM_alert(title,msg){var dialogObj=$("<div style='display:none' title='"+title+"'>"+msg+"</div>");$("body").append(dialogObj);$(dialogObj).dialog({resizable:false,modal:true,buttons:{OK:function(){$(this).dialog("close");$(this).remove()}}})}function ACRM_dialog(title,msg,width,pre){var dialogObj;if(pre){dialogObj=$("<div style='display:none' title='"+title+"'><pre>"+msg+"</pre></div>")}else{dialogObj=$("<div style='display:none' title='"+title+"'>"+msg+"</div>")}$("body").append(dialogObj);$(dialogObj).dialog({resizable:false,width:width,modal:true,buttons:{Dismiss:function(){$(this).dialog("close");$(this).remove()}}})}function chainChange(labels,autoLabels,divId){if(labels==undefined||autoLabels){return gSequenceLengths[divId]}else{var res=labels.length;for(var i=0;i<labels.length-1;i++)if(labels[i].substring(0,1)!=labels[i+1].substring(0,1)){res=i}return res}}function JSAV_buildLabelsHTML(divId,seqLen,labels,cc){var html="";var pref;var labelNumbers="";for(var i=0;i<labels.length;i++){pref="";if(i==cc){pref="br_"}var cellCol=labels[i].substring(0,1)=="l"?"light-txt":"heavy-txt";var labelText=labels[i].replace(/^[A-Za-z]/g,"");var lastChar=labelText.substring(labelText.length-1,labelText.length);html+="<td class='"+pref+cellCol+"'>";if(lastChar=="0"){labelNumbers=labelText}if(labelNumbers.length>0){html+=labelNumbers[0];labelNumbers=labelNumbers.substring(1,labelNumbers.length)}html+="</td>"}html+="<td class='rhcol'></td></tr><tr class='labelrow'><td>&nbsp;</td><td>&nbsp;</td></td>";for(var i=0;i<labels.length;i++){pref="";if(i==cc){pref="br_"}var cellCol=labels[i].substring(0,1)=="l"?"light-txt":"heavy-txt";var labelText=labels[i].replace(/^[A-Za-z]/g,"");var lastChar=labelText.substring(labelText.length-1,labelText.length);html+="<td class='tooltip "+pref+cellCol+"' title='"+labels[i]+"'>";if(lastChar=="0"){html+="|"}else if(lastChar.match(/[A-Za-z]/)){html+=lastChar}else{html+="."}html+="</td>"}return html}function JSAV_autoLabels(sequences){var seqLen=sequences[0].sequence.length;var labels=Array();for(var i=1;i<=seqLen;i++){labels.push(i.toString())}return labels}function initDisplayOrder(sequences){var dispOrder=[];for(var r=0;r<sequences.length;r++){dispOrder[r]=r}return dispOrder}function initDisplayColumn(divId,sequences,displayColumns){var stypes=["heavy","light"];var dispColumn={};for(var stype in stypes){for(var s=0;s<=sequences.length;s++){for(var key in sequences[s]){if(key!="sequence"&&key!="displayrow"&&key!="id"&&key.substring(6)!="Chain id"){var colheaders=key.split("_");var colname="";for(k=2;k<colheaders.length;k++){colname+=colheaders[k]+"_"}colname=colname.replace(/_+$/,"");colname=colname.trim();if(colheaders[0]==stypes[stype]){if(displayColumns&&displayColumns.hasOwnProperty(key)){dispColumn[key]=displayColumns[key]}else if(gOptions[divId].defaultVisibleColumns.indexOf(colname)>=0){dispColumn[key]=1}else{dispColumn[key]=0}}}}}}for(var term in gOptions[divId].searchTerms){for(var stype in stypes){for(var s=0;s<=sequences.length;s++){for(var key in sequences[s]){var colheaders=key.split("_");var colname="";for(k=2;k<colheaders.length;k++){colname+=colheaders[k]+""}colname=colname.trim();if(colname.toLowerCase()==term||term=="simple"){if(colheaders[0]==stypes[stype]){if(sequences[s][key].toLowerCase().indexOf(gOptions[divId].searchTerms[term].toLowerCase())>=0){if(displayColumns&&displayColumns.hasOwnProperty(key)){dispColumn[key]=displayColumns[key]}else{dispColumn[key]=0}}}}}}}}return dispColumn}function printDataTable(divId,sequences){var options=gOptions[divId];var ctype=options.chainType;var dispOrder=gDisplayOrder[divId];var tableDiv=divId+"_Table";var outerTableDiv=tableDiv+"Outer";var tableTag="#"+tableDiv;var html="";html+=printToggleList(divId);html+="<div id='"+outerTableDiv+"'>";html+="<div class='header' style='padding-left:16px;'>";html+=printTableHeader(divId,options.selectable);html+="</div>";html+="<div id='"+tableDiv+"_Outer' class='outertablebody'>";html+="<div id='"+tableDiv+"_Inner' class='innertablebody'>";html+="<table class='results' border='1' id='"+divId+"_tablebody'>";for(var s=0;s<sequences.length;s++){html+=printDataRow(divId,sequences[dispOrder[s]])}html+="</table>";html+="</div></div></div>";html+="<div id='"+tableDiv+"_Controls' class='JSAVControls'>";html+="</div>";$("#"+tableDiv).html(html);if(options.hideable){JSAV_ControlButton(divId,tableDiv+"_Controls","Hide selected sequences",options.hideLabel,"","Hide Sequences",'JSAV_hideSelectedSequences("'+divId+'")');JSAV_ControlButton(divId,tableDiv+"_Controls","Show hidden sequences",options.showallLabel,"","Show Hidden Sequences",'JSAV_resetDisplayrow("'+divId+'")')}if(options.exportable){JSAV_ControlButton(divId,tableDiv+"_Controls","Export visible sequences to CSV",options.exportLabel,"CSV","Export CSV",'JSON2CSV("'+divId+'")');JSAV_ControlButton(divId,tableDiv+"_Controls","Export visible sequences to XML for Excel - your Excel must support XML import",options.exportLabel,"Excel","Export Excel",'JSON2XML("'+divId+'")')}$("#"+divId+"_tablebody").css("width",gTableWidth[divId]+6);$("#"+tableDiv+"_Outer").css("width",gTableWidth[divId]+24);$("#"+tableDiv+"_Inner").css("width",gTableWidth[divId]+8);$("#"+outerTableDiv).css("width","98vw");$("#"+outerTableDiv).css("margin-left","0.5em");$("#"+outerTableDiv).css("overflow-x","auto")}function notColumnGroup(col){var colGroups=["General","PTMs","CDRs","Canonical Classes","Structural Environment","Modelled Structural Environment","Regions(Chothia definition)","Regions(AbM definition)","Regions(Kabat definition)","Regions(Contact definition)","Regions(IMGT definition)","Positions","Blast"];return colGroups.indexOf(col)==-1?true:false}function tidySequences(divId,sequences){var section;var stypes=["heavy","light"];for(var s=0;s<sequences.length;s++){for(var key in sequences[s]){var row=key.split("_");var newkey=key;section=stypes.includes(row[0])?1:0;if(row[section]&&row[section]!="Chain id"&&row[section]!="sequence"&&row[section]!="id"&&row[section]!="frequencies"){if(notColumnGroup(row[section])){newkey=key.replace(row[section],"_"+row[section])}}if(row[section]&&row[section]!="sequence"&&row[section]!="id"&&row[section]!="frequencies"){if(!stypes.includes(row[0])){newkey="heavy_"+newkey}}if(newkey!=key){sequences[s][newkey]=sequences[s][key];delete sequences[s][key]}}}}function resetDisplayColumn(displayColumn,sequences){for(var key in displayColumn){if(key!="sequence"&&key!="displayrow"&&key!="id"&&key.substring(6)!="Chain id"){if(displayColumn[key]>0){displayColumn[key]=1}}}}function compareVals(colVal,hiVal,numeric){if(numeric){if(Number(colVal)>Number(hiVal))return 1;else if(Number(colVal)<Number(hiVal))return-1;else return 0}else{if(colVal>hiVal)return 1;else if(colVal<hiVal)return-1;else return 0}}function DT_sortColumn(divId,direction,colName){var options=gOptions[divId];var sequence=gSequences[divId];var numeric=true;var idxFree=[];var hV=-1;gStartPos[divId]=1;gStopPos[divId]=gSequenceLengths[divId];for(var r1=0;r1<sequence.length;r1++){idxFree[r1]=true;if(isNaN(sequence[r1][colName])){hV="";numeric=false}}if(direction=="asc"){for(var r1=sequence.length-1;r1>=0;r1--){var hiVal=hV;var idx=0;for(var r2=0;r2<sequence.length;r2++){if(idxFree[r2]){if(compareVals(sequence[r2][colName],hiVal,numeric)>=0){hiVal=sequence[r2][colName];idx=r2}}}idxFree[idx]=false;gDisplayOrder[divId][r1]=idx}gDisplayColumn[gOptions[divId].chainType][colName]=2}else{for(var r1=0;r1<sequence.length;r1++){var hiVal=hV;var idx=0;for(var r2=0;r2<sequence.length;r2++){if(idxFree[r2]){if(compareVals(sequence[r2][colName],hiVal,numeric)>0){hiVal=sequence[r2][colName];idx=r2}}}idxFree[idx]=false;gDisplayOrder[divId][r1]=idx}gDisplayColumn[gOptions[divId].chainType][colName]=3}for(var key in gDisplayColumn[gOptions[divId].chainType]){if(key!=colName&&gDisplayColumn[gOptions[divId].chainType][key]!=0){gDisplayColumn[gOptions[divId].chainType][key]=1}}JSAV_refresh(divId,gSequences[divId],0,gSequences[divId][0].sequence.length-1)}function DT_toggleColumn(divId,colName){if(gDisplayColumn[gOptions[divId].chainType][colName]){gDisplayColumn[gOptions[divId].chainType][colName]=0}else{gDisplayColumn[gOptions[divId].chainType][colName]=1}printDataTable(divId,gSequences[divId])}function printToggleList(divId){var stypes=["heavy","light"];var html="";var grpList=[];var hiddenGroups=0;for(var stype in stypes){for(var key in gDisplayColumn[gOptions[divId].chainType]){if(gDisplayColumn[gOptions[divId].chainType][key]==false){hiddenGroups=1;var keyList=key.split("_");if(keyList[0]==stypes[stype]){var grpGroup=keyList[0]+"_"+keyList[1];if(grpList.indexOf(grpGroup)==-1){grpList.push(grpGroup)}}}}}for(var i=0;i<grpList.length;i++){var grpType=grpList[i].split("_");html+="<select class='toggle-col-list "+grpType[0]+"button' onchange='DT_toggleColumn(\""+divId+"\",this.value);'>";var gTitle=grpType[1]==""?"Select":grpType[1];html+="<option style='display:none;' disabled='disabled' selected='selected'>"+gTitle+"</option> ";for(var key in gDisplayColumn[gOptions[divId].chainType]){if(gDisplayColumn[gOptions[divId].chainType][key]==false){var keyList=key.split("_");if(grpList[i]==keyList[0]+"_"+keyList[1]){var keyText="";for(var k=2;k<keyList.length;k++){keyText+=keyList[k]+" "}keyText=keyText.trim();var desc=keyText;if(gOptions[divId].ptmLabels){desc=gOptions[divId].ptmLabels.hasOwnProperty(keyText)?gOptions[divId].ptmLabels[keyText]:keyText}html+="<option class='tooltip' title='Show "+desc+"' value='"+key+"'>"+keyText+"</option>"}}}html+="</select>"}var divHtml="<div class='toggle-col-list'";if(!hiddenGroups)divHtml+=" style='display:none'";divHtml+=">Show hidden columns: ";html+="</div>";return divHtml+html}function printTableHeader(divId,selectable){var html="<table class='results' border='1' id='"+divId+"_tablehead'>";var options=gOptions[divId];var maxrows=0;for(var key in gDisplayColumn[options.chainType]){if(gDisplayColumn[options.chainType][key]){var numrows=key.split("_");if(numrows.length>maxrows)maxrows=numrows.length}}for(var row=0;row<maxrows;row++){html+="<tr>";gTableWidth[divId]=120;if(row>0){var bgcol=options.chainType=="combined"?"heavy-col":options.chainType+"-col";html+=JSAV_buildSelectAllHTML(divId,selectable,row==maxrows-1,"lrborderheader "+bgcol);html+="<th class='idCell "+bgcol+"'>";if(row==2)html+="ID";html+="</th>"}var colspan=3;var rowstart=true;var lastcell="";var lasthtml="";for(var key in gDisplayColumn[options.chainType]){if(gDisplayColumn[options.chainType][key]){var colheaders=key.split("_");var colheader="";var colName="";for(var k=2;k<colheaders.length;k++){colName+=colheaders[k]+" "}colName=colName.trim();var colClass=colheaders[0]+"-col";var colDesc=colName;if(options.ptmLabels){colDesc=options.ptmLabels.hasOwnProperty(colName)?options.ptmLabels[colName]:colName}var colWidth=50;if(options.formattedCols){colWidth=colName in options.formattedCols?options.formattedCols[colName]:50}gTableWidth[divId]+=colWidth+40;for(var r=0;r<=row;r++){colheader+=colheaders[r]}var htmlcell="";if(colheader==lastcell){colspan+=3}else{colspan=3}if(row==0){var seqtype=colheaders[0]}else if(row==colheaders.length-1){switch(gDisplayColumn[options.chainType][key]){case 2:var icon=options.sortDownLabel;var textLbl=options.sortDownText;var direction="desc";break;case 3:var icon=options.sortUpLabel;var textLbl=options.sortUpText;var direction="asc";break;default:var icon=options.sortBothLabel;var textLbl=options.sortBothText;var direction="asc"}var toggleclick="onclick='DT_toggleColumn(\""+divId+'", "'+key+"\");'";var sortclick="onclick='DT_sortColumn(\""+divId+'", "'+direction+'", "'+key+"\");'";htmlcell+="<th class='"+colClass+" headerHide'>";htmlcell+="<div "+toggleclick+"><i class='"+options.hideLabel+" fa-inverse tooltip' title='Hide Column "+colDesc+"'>";htmlcell+="</i>"+options.hideText+"</div></th>";htmlcell+="<th class='"+colClass+" headerText' style='min-width:"+colWidth+"px;max-width:"+colWidth+"px;'>";htmlcell+="<div class='truncated tooltip' title='"+colDesc+"'>"+colheaders[row]+"</div></th>";htmlcell+="<th class='"+colClass+" headerSort'>";if(options.sortable){htmlcell+="<div "+sortclick+"><i class='"+icon+" fa-inverse fa-lg tooltip' title='Sort Column "+colName+"'></i>"+textLbl+"<div>"}htmlcell+="</th>"}else{if(row<colheaders.length-1){var colSpread=colWidth*colspan/3}else{var colSpread=colWidth}htmlcell+="<th class='lrborderheader "+colClass+"' colspan="+colspan+" style='width:"+colSpread+"px;'>";htmlcell+="<div class='truncated'>";if(row<colheaders.length)htmlcell+=colheaders[row];htmlcell+="</div></th>"}if(rowstart){rowstart=false}else if(colheader!=lastcell){html+=lasthtml}lasthtml=htmlcell;lastcell=colheader}}html+=lasthtml+"</tr>"}html+="</table>";return html}function printDataRow(divId,sequence){var options=gOptions[divId];var html="";if(sequence.displayrow){html+="<tr id = 'table_"+sequence.id+"'>";if(options.selectable){var name="select_"+sequence.id;var cname=name.replace(/\./g,"_").replace(/\//g,"_");var checked=$("."+cname).prop("checked")?"checked":"";var onclick="onclick='JSAV_resetAllNone(\""+divId+'","'+cname+"\",this.checked);'";html+="<td><input class='"+cname+" selectBox' type='checkbox' name='"+name+"' "+checked+" "+onclick+"/></td>"}var attrArray=options.idSubmitAttribute.split(":");var idSubmitAttr="";for(var a=0;a<attrArray.length;a++){idSubmitAttr+=sequence[attrArray[a]]+":"}idSubmitAttr=idSubmitAttr.replace(/:$/,"");html+=JSAV_buildId(divId,idSubmitAttr,sequence.id,options.idSubmit,options.idSubmitKey,1,"idCell",options.humanOrganism)+"\n";for(var key in gDisplayColumn[gOptions[divId].chainType]){if(gDisplayColumn[gOptions[divId].chainType][key]){var colheaders=key.split("_");var colName="";for(var k=2;k<colheaders.length;k++)colName+=colheaders[k]+" ";colName=colName.trim();var lcColName="other";var colWidth=90;if(options.formattedCols){lcColname=colName in options.formattedCols?colName.toLowerCase():"other";colWidth=colName in options.formattedCols?options.formattedCols[colName]+40:90}var matchcol=colheaders[0]+"_Numbered";var feint=sequence[matchcol]=="N"?" feint":"";if(typeof sequence[key]=="undefined"){html+="<td></td>"}else{var cellText=sequence[key];for(var term in options.searchTerms){if(term=="simple"||colName.toLowerCase()==term){var re=new RegExp(options.searchTerms[term],"i");if(sequence[key].search(re)!=-1){var cellArr=sequence[key].replace(/\>/g,"> ").split(" ");cellText="";for(var c=0;c<cellArr.length;c++){var cellWord=cellArr[c]+" ";if(cellWord.search(re)!=-1){cellWord="<span class='highlightmatch'>"+cellWord.toUpperCase()+"</span>"}cellText+=cellWord}}}}html+="<td class='bodyText' style='min-width:"+colWidth+"px;max-width:"+colWidth+"px;'><div class='wwrap "+lcColName+feint+"'>";html+=decodeURIComponent(cellText)+"</div></td>"}}}html+="</tr>"}return html}function JSON2CSV(divId){var sequence=gSequences[divId];var dispOrder=gDisplayOrder[divId];var CSV="";var row="";var columns=[];columns["heavy"]=new Array;columns["light"]=new Array;for(var s in sequence[0]){if(gDisplayColumn[gOptions[divId].chainType][s]){if(columns[s.substring(0,5)].indexOf("id")==-1){columns[s.substring(0,5)].push("id")}columns[s.substring(0,5)].push(s)}}for(var t in columns){if(columns[t].length>0){row+='"'+t.toUpperCase()+'",';for(var d=1;d<columns[t].length;d++)row+=","}}CSV+=row.slice(0,-1)+"\r\n";row="";for(var t in columns){for(var c=0;c<columns[t].length;c++){row+=columns[t][c].substring(6)+","}}for(var s=0;s<gOptions[divId].labels.length;s++){row+=gOptions[divId].labels[s]+","}CSV+=row.slice(0,-1)+"\r\n";for(var i=0;i<sequence.length;i++){if(sequence[dispOrder[i]].displayrow){row="";for(var t in columns){for(var c=0;c<columns[t].length;c++){if(sequence[dispOrder[i]][columns[t][c]]==undefined){row+=","}else{row+='"'+sequence[dispOrder[i]][columns[t][c]]+'",'}}}for(var s=0;s<sequence[dispOrder[i]].sequence.length;s++){row+=sequence[dispOrder[i]].sequence[s]+","}CSV+=row.slice(0,-1)+"\r\n"}}if(CSV==""){alert("Invalid data");return}var link=document.createElement("a");var browser=window.navigator.userAgent;var appStr="data:text/csv;charset=utf-8";var fileName="JSAV_Export.csv";if(browser.indexOf("MSIE ")>0||browser.indexOf("Trident/")>0||browser.indexOf("Edge/")>0){var blob=new Blob([CSV],{type:appStr});window.navigator.msSaveBlob(blob,fileName)}else{link.href=appStr+","+encodeURIComponent(CSV);link.style="visibility:hidden";link.download=fileName;document.body.appendChild(link);link.click();document.body.removeChild(link)}}function JSON2XML(divId){var sequence=gSequences[divId];var dispOrder=gDisplayOrder[divId];var options=gOptions[divId];var columns=[];var dnaColumn=0;columns["heavy"]=new Array;columns["light"]=new Array;var XML='<?xml version="1.0"?>\r\n<?mso-application progid="Excel.Sheet"?>\r\n';XML+='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\r\nxmlns:o="urn:schemas-microsoft-con:office:office"\r\n';XML+='xmlns:x="urn:schemas-microsoft-com:office:excel"\r\nxmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"\r\n';XML+='xmlns:html="http://www.w3.org/TR/REC-html40">\r\n';XML+='<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"></DocumentProperties>\r\n';XML+='<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel"></ExcelWorkbook>\r\n';XML+='<Styles>\r\n <Style ss:ID="columnHeader">';XML+='  <Alignment ss:Horizontal="Center"/>\r\n';XML+='  <Font ss:Bold="1"/>\r\n';XML+=" </Style>\r\n";if(typeof aaColours!=="undefined"){for(var c in aaColours[options.colourScheme]){XML+=' <Style ss:ID="'+c+'">';XML+='  <Interior ss:Color="'+aaColours[options.colourScheme][c]+'" ss:Pattern="Solid" />';XML+=" </Style>\r\n"}}XML+=' <Style ss:ID="heavy">';XML+='  <Interior ss:Color="#666666" ss:Pattern="Solid" />';XML+=" </Style>\r\n";XML+=' <Style ss:ID="light">';XML+='  <Interior ss:Color="#999999" ss:Pattern="Solid" />';XML+=" </Style>\r\n";XML+="</Styles>\r\n";XML+='<Worksheet ss:Name="abysis_output">\r\n<Table x:FullColumns="1" x:FullRows="1" ss:DefaultRowHeight="15">\r\n';var chainId=Array();for(var s in sequence[0]){if(s.substring(6)=="General_Dna"){dnaColumn=1}if(gDisplayColumn[gOptions[divId].chainType][s]){if(chainId.indexOf(gOptions[divId].chainType)==-1){chainId.push(gOptions[divId].chainType);XML+='  <Column ss:AutoFitWidth="0" ss:Width="100"/>\r\n';columns[gOptions[divId].chainType].push("id")}XML+='  <Column ss:AutoFitWidth="0" ss:Width="'+s.length*4+'"/>\r\n';columns[s.substring(0,5)].push(s)}}for(var s=0;s<sequence[0].sequence.length;s++){XML+='  <Column ss:AutoFitWidth="0" ss:Width="15.0"/>\r\n'}XML+='<Row ss:StyleID="columnHeader">\r\n';for(var t in columns){if(columns[t].length>0){XML+='  <Cell ss:StyleID="'+t+'" ss:MergeAcross="'+(columns[t].length-1)+'"><Data ss:Type="String">'+t.toUpperCase();XML+="</Data></Cell>\r\n"}}XML+="</Row>\r\n";XML+='<Row ss:StyleID="columnHeader">\r\n';for(var t in columns){for(var c=0;c<columns[t].length;c++){XML+='  <Cell ss:StyleID="'+t+'"><Data ss:Type="String">'+columns[t][c].substring(6)+"</Data></Cell>\r\n"}}if(options.labels!=undefined){for(var s=0;s<options.labels.length;s++){XML+='  <Cell><Data ss:Type="String">'+options.labels[s]+"</Data></Cell>\r\n"}}XML+="</Row>\r\n";if(gOptions[divId].blastaaquery!=undefined&&gOptions[divId].blastaaquery!=""){row="<Row>\r\n";row+='  <Cell><Data ss:Type="String">Blast Query</Data></Cell>\r\n';for(var t in columns){for(var c=1;c<columns[t].length;c++){row+='  <Cell><Data ss:Type="String"> </Data></Cell>\r\n'}}var blastArray=gOptions[divId].blastaaquery.split("");for(var s=0;s<blastArray.length;s++){row+="  <Cell";var r=blastArray[s];if(typeof aaColours!=="undefined"&&aaColours[gOptions[divId].colourScheme].hasOwnProperty(r)){row+=' ss:StyleID="'+r+'"'}row+='><Data ss:Type="String">'+r+"</Data></Cell>\r\n"}row+="</Row>\r\n";XML+=row}for(var i=0;i<sequence.length;i++){if(sequence[dispOrder[i]].displayrow){row="<Row>\r\n";for(var t in columns){for(var c=0;c<columns[t].length;c++){if(sequence[dispOrder[i]][columns[t][c]]==undefined){row+='  <Cell><Data ss:Type="String"> </Data></Cell>\r\n'}else{row+='  <Cell><Data ss:Type="String">'+sequence[dispOrder[i]][columns[t][c]]+"</Data></Cell>\r\n"}}}for(var s=0;s<sequence[dispOrder[i]].sequence.length;s++){row+="  <Cell";var r=sequence[dispOrder[i]].sequence[s];if(typeof aaColours!=="undefined"&&options.colourScheme!=="frequencies"&&aaColours[options.colourScheme].hasOwnProperty(r)){row+=' ss:StyleID="'+r+'"'}row+='><Data ss:Type="String">'+r+"</Data></Cell>\r\n"}row+="</Row>";XML+=row}}XML+="</Table></Worksheet>";if(options.regionTypes){XML+='<Worksheet ss:Name="CDR regions">\r\n<Table x:FullColumns="1" x:FullRows="1" ss:DefaultRowHeight="15">\r\n';var intoCDR=0;var newHighlight=[];for(h=0;h<options.highlight.length;h++){newHighlight[h]=options.highlight[h]+intoCDR-1;intoCDR=intoCDR==1?0:1}XML+='  <Column ss:AutoFitWidth="0" ss:Width="100.0"/>\r\n';for(c=0;c<newHighlight.length;c++){var colWidth=c==0?newHighlight[0]*10:(newHighlight[c]-newHighlight[c-1])*10;XML+='  <Column ss:AutoFitWidth="0" ss:Width="'+colWidth+'"/>\r\n'}XML+='  <Column ss:AutoFitWidth="0" ss:Width="100.0"/>\r\n';XML+='  <Column ss:AutoFitWidth="0" ss:Width="200.0"/>\r\n';if(dnaColumn){XML+='  <Column ss:AutoFitWidth="0" ss:Width="400.0"/>\r\n'}row="<Row>\r\n";row+='  <Cell><Data ss:Type="String"> </Data></Cell>\r\n';for(r=0;r<options.regionTypes.length;r++){row+='  <Cell><Data ss:Type="String">'+options.regionTypes[r]+"</Data></Cell>\r\n"}row+='  <Cell><Data ss:Type="String">SEQUENCE</Data></Cell>\r\n';if(dnaColumn){row+='  <Cell><Data ss:Type="String">DNA</Data></Cell>\r\n'}row+="</Row>";XML+=row;var dispStr="";for(var i=0;i<sequence.length;i++){if(sequence[dispOrder[i]].displayrow){row="<Row>\r\n";row+='  <Cell><Data ss:Type="String">'+sequence[dispOrder[i]].id+"</Data></Cell>\r\n";for(var s=0;s<sequence[dispOrder[i]].sequence.length;s++){dispStr+=sequence[dispOrder[i]].sequence[s];if(newHighlight.indexOf(s)!=-1){row+='  <Cell><Data ss:Type="String">'+dispStr.replace(/-/g,"")+"</Data></Cell>\r\n";dispStr=""}}row+='  <Cell><Data ss:Type="String">'+dispStr.replace(/-/g,"")+"</Data></Cell>\r\n";row+='  <Cell><Data ss:Type="String">'+sequence[dispOrder[i]].sequence.replace(/-/g,"")+"</Data></Cell>\r\n";if(dnaColumn){var dna="";if(sequence[dispOrder[i]].hasOwnProperty("heavy_General_Dna"))dna+=sequence[dispOrder[i]]["heavy_General_Dna"];if(sequence[dispOrder[i]].hasOwnProperty("light_General_Dna"))dna+=sequence[dispOrder[i]]["light_General_Dna"];row+='  <Cell><Data ss:Type="String">'+dna+"</Data></Cell>\r\n"}row+="</Row>";XML+=row}}XML+="</Table></Worksheet>"}XML+="</Workbook>";if(XML==""){alert("Invalid data");return}var link=document.createElement("a");var browser=window.navigator.userAgent;var appStr="data:application/xml;charset=utf-8";var fileName="JSAV_Export.xml";if(browser.indexOf("MSIE ")>0||browser.indexOf("Trident/")>0||browser.indexOf("Edge/")>0){var blob=new Blob([XML],{type:appStr});window.navigator.msSaveBlob(blob,fileName)}else{link.href=appStr+","+encodeURIComponent(XML);link.style="visibility:hidden";link.download=fileName;document.body.appendChild(link);link.click();document.body.removeChild(link)}}